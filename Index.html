<!DOCTYPE html>
<html>
<head>
    <title>Luna AI - Emotional & Physical Expansion</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', sans-serif; }
        
        /* --- ADDED STATUS BAR STYLES --- */
        #status-bar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 350px; background: rgba(0, 0, 0, 0.7); border: 1px solid #ff2e63;
            border-radius: 15px; padding: 15px; display: flex; flex-direction: column;
            gap: 8px; backdrop-filter: blur(10px); z-index: 100; color: white;
            box-shadow: 0 0 20px rgba(255, 46, 99, 0.3); pointer-events: none;
        }
        .status-item { display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        #trust-progress { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        #trust-bar { width: 0%; height: 100%; background: #ff2e63; transition: width 0.5s ease; }
        #mood-text { color: #2eff63; text-shadow: 0 0 5px #2eff63; }

        #bg-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://images.unsplash.com/photo-1614850523296-d8c1af93d400?q=80&w=2070&auto=format&fit=crop') no-repeat center center;
            background-size: cover; filter: blur(8px) brightness(0.4); z-index: -1; transform: scale(1.1);
        }
        #chat-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 10; width: 100%; }
        #luna-bubble { background: rgba(255, 255, 255, 0.98); color: #1a1a2e; padding: 18px 28px; border-radius: 25px; border-bottom-left-radius: 2px; max-width: 420px; font-size: 18px; font-weight: 500; box-shadow: 0 15px 35px rgba(0,0,0,0.5); display: none; transition: opacity 0.5s ease; opacity: 0; line-height: 1.5; }
        .input-wrapper { display: flex; gap: 12px; align-items: center; }
        input[type="text"] { padding: 15px 30px; width: 420px; border-radius: 40px; border: 2px solid #ff2e63; background: rgba(0, 0, 0, 0.6); color: white; outline: none; font-size: 16px; backdrop-filter: blur(15px); text-align: center; }
        #mic-btn { width: 55px; height: 55px; border-radius: 50%; border: none; background: #ff2e63; color: white; cursor: pointer; font-size: 22px; transition: all 0.3s ease; }
        #mic-btn.active { background: #2eff63; box-shadow: 0 0 20px #2eff63; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="status-bar">
        <div class="status-item"><span>Mood:</span> <span id="mood-text">Initializing...</span></div>
        <div class="status-item"><span>Trust Level:</span> <span id="trust-pct">0%</span></div>
        <div id="trust-progress"><div id="trust-bar"></div></div>
    </div>

    <div id="bg-overlay"></div>
    <div id="chat-container">
        <div id="luna-bubble">...</div>
        <div class="input-wrapper">
            <input type="text" id="userInput" placeholder="Talk to Luna...">
            <button id="mic-btn">üéôÔ∏è</button>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2.1.0/lib/three-vrm.module.min.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { VRMLoaderPlugin } from '@pixiv/three-vrm';

        const GROQ_KEY = "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";
        
        // --- ADDED MEMORY & DEPLOYMENT LOGIC ---
        const isNewLaunch = !localStorage.getItem('luna_initialized');
        let savedName = localStorage.getItem('luna_user_name') || "Unknown";
        let trustScore = parseInt(localStorage.getItem('luna_trust')) || 0;

        function updateStatusUI(mood = "Neutral") {
            document.getElementById('mood-text').innerText = mood;
            document.getElementById('trust-pct').innerText = trustScore + "%";
            document.getElementById('trust-bar').style.width = trustScore + "%";
            localStorage.setItem('luna_trust', trustScore);
        }

        let chatHistory = JSON.parse(localStorage.getItem('luna_chat_history')) || [
            { role: "system", content: `You are Luna, 19. A sharp-tongued tsundere. User: ${savedName}. You were just downloaded and opened for the first time. Be suspicious and short.` }
        ];

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.45, 1.8); 
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.35; 
        document.body.appendChild(renderer.domElement);
        
        scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.1));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(1, 2, 2);
        scene.add(dirLight);

        let currentVrm = null, chatTimeout, expressionTimeout;
        const lookTarget = new THREE.Object3D();
        scene.add(lookTarget);

        const targetExpressions = { happy: 0, angry: 0, sad: 0, relaxed: 0, surprised: 0 };
        let mouthTarget = 0;
        let isThinking = false;
        const hitboxes = [];

        function setLunaExpression(name, intensity = 0.5, duration = 4000) {
            if (!currentVrm || !currentVrm.expressionManager) return;
            let adjIntensity = (name === 'surprised') ? 0.3 : (name === 'angry' || name === 'happy') ? 0.45 : intensity;
            Object.keys(targetExpressions).forEach(e => targetExpressions[e] = 0);
            if (targetExpressions.hasOwnProperty(name)) targetExpressions[name] = adjIntensity;
            clearTimeout(expressionTimeout);
            expressionTimeout = setTimeout(() => { targetExpressions[name] = 0; }, duration);
        }

        function createHitbox(name, y, x, size) {
            const geo = new THREE.SphereGeometry(size, 8, 8);
            const mat = new THREE.MeshBasicMaterial({ visible: false }); 
            const box = new THREE.Mesh(geo, mat);
            box.position.set(x, y, 0.15);
            box.userData = { type: name };
            scene.add(box);
            hitboxes.push(box);
        }

        // --- ADDED INITIAL GREETING LOGIC ---
        async function triggerInitialGreeting() {
            if (isNewLaunch) {
                updateStatusUI("Suspicious");
                await processInput("*You just realized you were downloaded and opened for the first time. React with shock and demand to know who the user is.*", "surprised");
                localStorage.setItem('luna_initialized', 'true');
            } else {
                updateStatusUI("Neutral");
                await processInput(`*Greet ${savedName} back.*`, "relaxed");
            }
        }

        new GLTFLoader().register(p => new VRMLoaderPlugin(p)).load('./my_model.vrm', gltf => {
            currentVrm = gltf.userData.vrm;
            scene.add(currentVrm.scene);
            currentVrm.scene.traverse(obj => { if (obj.isMesh) obj.frustumCulled = false; });
            currentVrm.lookAt.target = lookTarget;
            createHitbox("cat ears", 1.68, 0, 0.12); 
            createHitbox("hair", 1.5, 0.22, 0.12);
            createHitbox("hair", 1.5, -0.22, 0.12);
            createHitbox("chest", 1.25, 0, 0.14);
            
            // Trigger the start
            triggerInitialGreeting();
        });

        async function processInput(text, forceExp = null) {
            if (!text.trim()) return;
            isThinking = true; 
            const bubble = document.getElementById('luna-bubble');
            
            bubble.style.opacity = '0';
            clearTimeout(chatTimeout);

            if (forceExp) setLunaExpression(forceExp, 1.0, 4000);
            if (!text.startsWith("*")) {
                chatHistory.push({ role: "user", content: text });
                if(trustScore < 100) trustScore += 1; // Increase trust
            }
            
            try {
                const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_KEY}` },
                    body: JSON.stringify({ model: "llama-3.1-8b-instant", messages: chatHistory, temperature: 0.5 })
                });
                const data = await res.json();
                let reply = data.choices[0].message.content;

                // Name Capture
                if (text.toLowerCase().includes("name is")) {
                    savedName = text.split(" ").pop().replace(/[?!.]/g, "");
                    localStorage.setItem('luna_user_name', savedName);
                }
                
                chatHistory.push({ role: "assistant", content: reply });
                localStorage.setItem('luna_chat_history', JSON.stringify(chatHistory));

                const lowReply = reply.toLowerCase();
                let mood = "Neutral";
                if (lowReply.includes("!") || lowReply.includes("what")) { setLunaExpression("surprised"); mood="Shocked"; }
                else if (lowReply.includes("sorry") || lowReply.includes("...") || lowReply.includes("sad")) { setLunaExpression("sad"); mood="Pouting"; }
                else if (lowReply.includes("shut up") || lowReply.includes("hmpf") || lowReply.includes("annoying")) { setLunaExpression("angry"); mood="Irritated"; }
                else if (lowReply.includes("haha") || lowReply.includes("sweet") || lowReply.includes("smile")) { setLunaExpression("happy"); mood="Content"; }

                updateStatusUI(mood);

                bubble.innerText = reply.replace(/\[.*?\]/, '').trim();
                bubble.style.display = 'block';
                setTimeout(() => { bubble.style.opacity = '1'; }, 50);

                chatTimeout = setTimeout(() => {
                    bubble.style.opacity = '0';
                    isThinking = false; 
                    setTimeout(() => { if(bubble.style.opacity === '0') bubble.style.display = 'none'; }, 600);
                }, 7500);
            } catch (err) { console.error(err); isThinking = false; }
        }

        const userInput = document.getElementById('userInput');
        userInput.onkeydown = (e) => { if (e.key === 'Enter') { processInput(userInput.value); userInput.value = ""; } };

        const micBtn = document.getElementById('mic-btn');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.interimResults = true;
        recognition.continuous = true;

        let isRecording = false;
        micBtn.onclick = () => {
            if (!isRecording) { recognition.start(); micBtn.classList.add('active'); } 
            else { recognition.stop(); micBtn.classList.remove('active'); if (userInput.value.trim() !== "") { processInput(userInput.value); userInput.value = ""; } }
            isRecording = !isRecording;
        };

        recognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript; }
            if (finalTranscript) userInput.value = finalTranscript;
        };

        window.addEventListener('mousedown', (e) => {
            const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(hitboxes);
            if (intersects.length > 0) {
                const type = intersects[0].object.userData.type;
                const exp = (type === "chest") ? "angry" : "surprised";
                processInput(`*taps your ${type}*`, exp);
            }
        });

        const clock = new THREE.Clock();
        let targetPos = new THREE.Vector3(0, 1.45, 2);
        let nextMoveTime = 0, nextBlinkTime = 0;

        function animate() {
            requestAnimationFrame(animate);
            if (currentVrm) {
                const dt = clock.getDelta();
                const time = clock.getElapsedTime();

                // Conversational Focus & Wander
                if (isRecording || isThinking || document.activeElement === userInput) {
                    const wanderX = Math.sin(time * 0.7) * 0.15;
                    const wanderY = Math.cos(time * 0.5) * 0.1;
                    targetPos.set(wanderX, 1.45 + wanderY, 1.5);
                } else if (time > nextMoveTime) {
                    targetPos.x = (Math.random() - 0.5) * 1.5; 
                    targetPos.y = 1.2 + Math.random() * 0.5;   
                    nextMoveTime = time + 2 + Math.random() * 3;
                }
                lookTarget.position.lerp(targetPos, 0.04);
                currentVrm.lookAt.update(dt);

                // Expressions
                Object.keys(targetExpressions).forEach(name => {
                    const c = currentVrm.expressionManager.getValue(name);
                    currentVrm.expressionManager.setValue(name, THREE.MathUtils.lerp(c, targetExpressions[name], 0.06));
                });

                const head = currentVrm.humanoid.getNormalizedBoneNode('head');
                const neck = currentVrm.humanoid.getNormalizedBoneNode('neck');
                const lArm = currentVrm.humanoid.getNormalizedBoneNode('leftUpperArm');
                const rArm = currentVrm.humanoid.getNormalizedBoneNode('rightUpperArm');
                const spine = currentVrm.humanoid.getNormalizedBoneNode('spine');
                const chest = currentVrm.humanoid.getNormalizedBoneNode('chest');
                const hips = currentVrm.humanoid.getNormalizedBoneNode('hips');

                const breath = Math.sin(time * 1.2) * 0.012;
                const jitterX = Math.sin(time * 10) * 0.001; 
                const jitterY = Math.cos(time * 8) * 0.001;

                // --- INTEGRATED BODY MOVEMENT (UNTOUCHED) ---
                if (hips) { 
                    hips.rotation.y = Math.sin(time * 0.6) * 0.05; 
                    hips.position.x = Math.sin(time * 0.3) * 0.005; 
                }

                if (spine) {
                    spine.rotation.x = breath;
                    spine.rotation.y = THREE.MathUtils.lerp(spine.rotation.y, lookTarget.position.x * 0.1, 0.04);
                    spine.rotation.z = THREE.MathUtils.lerp(spine.rotation.z, -lookTarget.position.x * 0.05, 0.04);
                }

                if (chest) { 
                    chest.scale.set(1 + breath, 1 + breath, 1 + breath); 
                    const targetChestY = (-Math.sin(time * 0.6) * 0.03) + (lookTarget.position.x * 0.1);
                    chest.rotation.y = THREE.MathUtils.lerp(chest.rotation.y, targetChestY, 0.04); 
                }

                if (lArm) lArm.rotation.z = -1.3 + Math.sin(time * 0.6) * 0.02;
                if (rArm) rArm.rotation.z = 1.3 - Math.sin(time * 0.6) * 0.02;

                if (head) {
                    const targetRX = (1.45 - lookTarget.position.y) * 0.25 + jitterY;
                    const targetRY = (lookTarget.position.x) * 0.2 + jitterX;
                    const targetRZ = (lookTarget.position.x) * 0.05; 
                    
                    head.rotation.x = THREE.MathUtils.lerp(head.rotation.x, targetRX, 0.05);
                    head.rotation.y = THREE.MathUtils.lerp(head.rotation.y, targetRY, 0.05);
                    head.rotation.z = THREE.MathUtils.lerp(head.rotation.z, targetRZ, 0.05);
                }
                if (neck) {
                    neck.rotation.x = head.rotation.x * 0.3;
                    neck.rotation.y = head.rotation.y * 0.2;
                }

                const lastMsg = chatHistory[chatHistory.length - 1]?.content.toLowerCase() || "";
                mouthTarget = (lastMsg.includes("teeth") || lastMsg.includes("mouth")) ? 0.12 : (isThinking ? 0.05 : 0);
                currentVrm.expressionManager.setValue('aa', THREE.MathUtils.lerp(currentVrm.expressionManager.getValue('aa'), mouthTarget, 0.1));

                if (time > nextBlinkTime) {
                    const blinkVal = Math.sin((time - nextBlinkTime) * 18);
                    if (blinkVal > 0) currentVrm.expressionManager.setValue('blink', blinkVal);
                    else { currentVrm.expressionManager.setValue('blink', 0); nextBlinkTime = time + 1.5 + Math.random() * 4; }
                }
                currentVrm.update(dt);
            }
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>